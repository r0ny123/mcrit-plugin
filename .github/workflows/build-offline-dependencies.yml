name: Build Offline Dependencies

on:
  push:
    tags:
      - '*'

jobs:
  build-dependencies:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        variant: [
          {name: "smda", packages: "smda"},
          {name: "full", packages: "smda ida-settings"}
        ]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Create virtual environment
      run: |
        python -m venv venv
        .\venv\Scripts\activate
        python -m pip install --upgrade pip wheel
        
    - name: Install dependencies
      run: |
        .\venv\Scripts\activate
        python -m pip install ${{ matrix.variant.packages }}
        
    - name: Generate requirements
      run: |
        .\venv\Scripts\activate
        python -m pip freeze > requirements-frozen.txt
        
    - name: Create wheels directory and download dependencies
      run: |
        .\venv\Scripts\activate
        New-Item -ItemType Directory -Path "wheels" -Force
        python -m pip wheel --wheel-dir wheels -r requirements-frozen.txt
        Copy-Item "requirements-frozen.txt" "wheels/requirements.txt"
        
    - name: Get release tag
      id: get_tag
      run: |
        $tag = "${{ github.ref_name }}"
        echo "tag=$tag" >> $env:GITHUB_OUTPUT
        
    - name: Create bundle
      run: |
        $bundleName = "mcrit-plugin-dependencies-${{ matrix.variant.name }}-winpy${{ matrix.python-version }}-${{ steps.get_tag.outputs.tag }}.zip"
        Compress-Archive -Path "wheels/*" -DestinationPath $bundleName
        echo "BUNDLE_NAME=$bundleName" >> $env:GITHUB_ENV
        
    - name: Upload bundle as artifact
      uses: actions/upload-artifact@v4
      with:
        name: mcrit-plugin-dependencies-${{ matrix.variant.name }}-winpy${{ matrix.python-version }}-${{ steps.get_tag.outputs.tag }}
        path: ${{ env.BUNDLE_NAME }}
        retention-days: 90
        
    - name: Upload bundle to release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: ${{ env.BUNDLE_NAME }}
        tag_name: ${{ steps.get_tag.outputs.tag }}
        token: ${{ secrets.GITHUB_TOKEN }}
